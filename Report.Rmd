---
title: "Report on my own edx project"
author: "FUNG CHE HEI"
date: "8/19/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r, echo=FALSE, message=FALSE}
#install packages that have not been downloaded
if(!require(tidyverse)) install.packages("tidyverse", repos = "http://cran.us.r-project.org")
if(!require(caret)) install.packages("caret", repos = "http://cran.us.r-project.org")
if(!require(data.table)) install.packages("data.table", repos = "http://cran.us.r-project.org")
if(!require(readr)) install.packages("readr", repos = "http://cran.us.r-project.org")
if(!require(dslabs)) install.packages("dslabs", repos = "http://cran.us.r-project.org")
if(!require(caret)) install.packages("caret", repos = "http://cran.us.r-project.org")
if(!require(lubridate)) install.packages("lubridate", repos = "http://cran.us.r-project.org")
if(!require(corrplot)) install.packages("corrplot", repos = "http://cran.us.r-project.org")
if(!require(knitr)) install.packages("knitt", repos = "http://cran.us.r-project.org")

#import any necessary library
library(tidyverse)
library(caret)
library(data.table)
library(readr)
library(dslabs)
library(caret)
library(lubridate)
library(corrplot)
library(knitr)

#Read csv data first, and then change them into data frame
seismic <- as.data.frame(read_csv("data/seismic_bumps.csv"))
```

# 1. Introduction

## 1.1 Background

There are many valuable minerals and geological materials in the Earth that are stored in the form of some kinds of ores, lode, vein and reef.  Mining is the human activities to extract those of them. Although mining activity seems interesting for human to discover different kinds of minerals in the Earth, it is a dangerous activities because a hazard of seismic bumps would occurs in many underground mines. Inaccurate prediction and detection would cause great damage to human life.

Therefore a good seismic hazard assessment is important and required for mining activities. With the aid of machine learning technologies, some research including clustering [1] and artificial neural networks [2] are used for prediction of seismic tremors in the past years.

## 1.2 Aim

Our main aim is:

* to forecast the high energy seismic bumps (higher than 10^4 J) in mine

With predicting the possibility of the occurrence of hazardous situation, appropriate risk assement and supervision service can be made. For example, reducing the risk of rockburst by the use of distressing shooting method and withdrawing workers from the threatened area.

## 1.3 Data set Information

The data set used is called "seismic-bumps Data Set" which is downloaded from UCI Machine Learning Repository. <https://archive.ics.uci.edu/ml/datasets/seismic-bumps#>

Here we read the downloaded data set and call it 'seismic'.

```{r, echo=TRUE,eval=FALSE}
seismic <- as.data.frame(read_csv("data/seismic_bumps.csv"))
```

### An overview on the seismic-bumps Data Set

```{r, echo=TRUE}
nrow(seismic)
```

```{r, echo=TRUE}
ncol(seismic)
```

```{r, echo=TRUE}
head(seismic)
```


After having a quick look on the data set, there are `r nrow(seismic)` rows (observations) and `r ncol(seismic)` columns (attributes). Each observation contains a summary statement about seismic activity in the rock mass within one shift (8 hours) which will be described in section 1.4, to predict 'hazardous' (positive class with value = 1) and 'non-hazardous' (negative class with value = 0) states. If 'hazardous' is predicted, it is possibly that seismic bump with an energy higher than 10^4 J would occur in the next shift. 

Here note the there is unbalanced distribution of positive and negative class. Among `r nrow(seismic)` observations, only `r sum(seismic$class == 1)` of them are positive class.

```{r, echo=TRUE}
sum(seismic$class == 1)
```


## 1.4 Arributes Information

* 1. seismic: result of shift seismic hazard assessment in the mine working obtained by the seismic 
method (a - lack of hazard, b - low hazard, c - high hazard, d - danger state); 
* 2. seismoacoustic: result of shift seismic hazard assessment in the mine working obtained by the 
seismoacoustic method; 
* 3. shift: information about type of a shift (W - coal-getting, N -preparation shift); 
* 4. genergy: seismic energy recorded within previous shift by the most active geophone (GMax) out of 
geophones monitoring the longwall; 
* 5. gpuls: a number of pulses recorded within previous shift by GMax; 
* 6. gdenergy: a deviation of energy recorded within previous shift by GMax from average energy recorded 
during eight previous shifts; 
* 7. gdpuls: a deviation of a number of pulses recorded within previous shift by GMax from average number of pulses recorded during eight previous shifts; 
* 8. ghazard: result of shift seismic hazard assessment in the mine working obtained by the 
seismoacoustic method based on registration coming from GMax only; 
* 9. nbumps: the number of seismic bumps recorded within previous shift; 
* 10. nbumps2: the number of seismic bumps (in energy range [10^2, 10^3)) registered within previous shift; 
* 11. nbumps3: the number of seismic bumps (in energy range [10^3, 10^4)) registered within previous shift; 
* 12. nbumps4: the number of seismic bumps (in energy range [10^4, 10^5)) registered within previous shift; 
* 13. nbumps5: the number of seismic bumps (in energy range [10^5, 10^6)) registered within the last shift; 
* 14. nbumps6: the number of seismic bumps (in energy range [10^6, 10^7)) registered within previous shift; 
* 15. nbumps7: the number of seismic bumps (in energy range [10^7, 10^8)) registered within previous shift; 
* 16. nbumps89: the number of seismic bumps (in energy range [10^8, 10^10)) registered within previous shift; 
* 17. energy: total energy of seismic bumps registered within previous shift; 
* 18. maxenergy: the maximum energy of the seismic bumps registered within previous shift; 
* 19. class: the decision attribute - '1' means that high energy seismic bump occurred in the next shift 
('hazardous state'), '0' means that no high energy seismic bumps occurred in the next shift 
('non-hazardous state').

## 1.5 Variables Information

There are totally 18 input variables (attributes) and 1 binary output variable (class) in the data set.
The below table summarize some information of the variables.

```{r, echo=FALSE,message=FALSE,warning=FALSE, results='asis'}
variable_summary<-seismic %>% summarise_all(funs("Total" = n(),
                     "Filled" = sum(!is.na(.)),
                     "Nulls" = sum(is.na(.)),
                     "Cardinality" = length(unique(.)))) %>%
  melt() %>%
  separate(variable, into = c('variable', 'measure'), sep="_") %>%
  spread(measure, value)  %>%
  mutate(Uniqueness = format(round(Cardinality/Total,1), nsmall = 1))

kable(variable_summary[,c(1,2,3,4,5,6)], caption = "Variable Summary Table")
```

Although 'maxenergy' and 'nbumps' are numeric data representing the magnitude of energy and number of bumps respectively, they have a relatively small cardinality which result in zero Uniqueness (defined by the ratio of Cardinality to Total). Therefore they are classified into categorical variables. For those variables with uniqueness greater than zero are then classified as numeric variables. Below is the table that summarizing the variable type of class and each attributes.

```{r}
names<- variable_summary$variable[-8] #remove id
kable(data.frame(Variable = names, 
           Type = c('binary','numeric','numeric','numeric','numeric','catagorical','numeric',
                    'catagorical','catagorical','catagorical','catagorical','catagorical','catagorical',
                    'catagorical','catagorical','catagorical','catagorical','catagorical','catagorical')), caption = "Variable Type")
```


## 1.6 Key Steps

***

# 2. Data Analysis

## 2.1 Data Cleaning

### 2.1.1 Present of Nulls 

Refer to Table 1 in section 1.5, there is no Null value in the data set therefore removing of those null values is not required.

### 2.1.2 Statistic

Statistic of attributes is presented as follow: 
    
```{r, echo=TRUE}
summary(seismic)
```

Refer to the above summary and looking at attributes 'nbumps6', 'nbumps7' and 'nbumps89', it is observed all the values are zero which means those of them do not provide any information for classifying positive and negative class. Therefore, we remove 'nbumps6', 'nbumps7' and 'nbumps89' from the entire data set. For the attribute 'id', it can be regarded as primary key of the data set and do not use for binary classification.
    
### 2.1.3 Correctness

It is obvious that the total number of seismic bumps (nbumps) equals to the sum of seismic bumps with different energy levels (nbumps2 + nbumps3 + ... + nbumps7 + nbumps89) and they should have no difference. The below code test this fact to ensure the correctness of the data set.

```{r, echo=TRUE}
#test the correctness of the data set
seismic %>% 
  mutate(total = nbumps2+nbumps3+nbumps4+nbumps5+nbumps6+nbumps7+nbumps89) %>%
  mutate(diff = total - nbumps) %>%
  filter(diff!=0) %>% 
  summarize(n=n()) %>%
  pull(n)
```

From the above result we can see that two observations suffer from the problem of inconsistency of the number of seismic bumps. Therefore these two observations will be removed from the entire data set and we call the corrected data set 'corrected_seismic'.

```{r, echo=TRUE,eval=FALSE}
#extract the index of incorrect data set
incorrect_index<- 
  seismic %>% 
  mutate(total = nbumps2+nbumps3+nbumps4+nbumps5+nbumps6+nbumps7+nbumps89) %>%
  mutate(diff = total - nbumps) %>%
  filter(diff!=0) %>% 
  pull(id)

#filter out the incorrect observations
#correct the data set
corrected_seismic<-
  seismic %>% 
  filter(id!=incorrect_index) %>%
  select(-nbumps6,-nbumps7,-nbumps89,-id)
```


## 2.2 Data Exploration and Visualization

### 2.2.1 Distribution of seismic (result of shift seismic hazard assessment) on mine with hazardous and non-hazardous state

In this section, the distribution of the result of shift seismic hazard assessment obtained by seismic method on mine with hazardous state and non-hazardous state is visualized. We can observe that the distribution of assessment result a (lack of hazard) and b (low hazard) is almost the same in mine with hazardous state. While the distribution of assessment result a (lack of hazard) is much higher than b (low hazard) in mine with non-hazardous state. The result is quite make sense since the mine with non-hazardous state should be more safe than that with  hazard state which is supported by the result of hazard assessment.

```{r, echo=FALSE, figures-side, fig.show="hold", out.width="50%"}
#extract the index of incorrect data set
incorrect_index<- 
  seismic %>% 
  mutate(total = nbumps2+nbumps3+nbumps4+nbumps5+nbumps6+nbumps7+nbumps89) %>%
  mutate(diff = total - nbumps) %>%
  filter(diff!=0) %>% 
  pull(id)

#filter out the incorrect observations
#correct the data set
corrected_seismic<-
  seismic %>% 
  filter(id!=incorrect_index) %>%
  select(-nbumps6,-nbumps7,-nbumps89,-id)

corrected_seismic %>%
  filter(class==1) %>%
  ggplot(aes(seismic)) +
  geom_bar(width = 0.1,fill="red",col="black") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  xlab("a - lack of hazard, b - low hazard") +
  ggtitle("seismic distribution on hazardous state \n(class 1)")

corrected_seismic %>%
  filter(class==0) %>%
  ggplot(aes(seismic)) +
  geom_bar(width = 0.1,fill="red",col="black") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  xlab("a - lack of hazard, b - low hazard") +
  ggtitle("seismic distribution on non-hazardous state \n(class 0)")
```


### 2.2.2 Distribution of seismoacoustic (result of shift seismic hazard assessment) on mine with hazardous and non-hazardous state

Similar to the previous section, the distribution of the result of shift seismic hazard assessment on mine with hazardous state and non-hazardous state is visualized, but the assessment result is obtained by seismoacoustic method. This time we can observe that the distribution of assessment result a (lack of hazard), b (low hazard) and c (high hazard) are almost the same in mine with hazardous state and non-hazardous state. This is pretty much surprise because we can deduce from the result that possibly the seismic hazard assessment result do not affect whether the mine is to be classified as hazardous or non-hazardous. The main reason may cause by the method used for hazard assessment this time is different from the previous one.

```{r, echo=FALSE, fig.show="hold", out.width="50%"}
corrected_seismic %>%
  filter(class==1) %>%
  ggplot(aes(seismoacoustic)) +
  geom_bar(width = 0.2,fill="red",col="black") +
  xlab("a - lack of hazard, b - low hazard, c - high hazard") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  ggtitle("seismoacoustic distribution on hazardous state \n(class 1)")

corrected_seismic %>%
  filter(class==0) %>%
  ggplot(aes(seismoacoustic)) +
  geom_bar(width = 0.2,fill="red",col="black") +
  xlab("a - lack of hazard, b - low hazard, c - high hazard") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  ggtitle("seismoacoustic distribution on non-hazardous state \n(class 0)")
```

### 2.2.3 Distribution of shift type on mine with hazardous and non-hazardous state

The effects of shift type (coal-getting or preparation) on seismic hazard of mine can be observed in the below graphs. Comparing to mine with non-hazardous state, it clearly shows that the ratio of W to N (i.e. the ratio of time period of coal-getting to preparation in mine) is much higher in mine with hazardous state. This comes to a reasonable observation because there is a possibility that coal-getting activity would trigger a high energy seismic bumps.

```{r, echo=FALSE, fig.show="hold", out.width="50%"}
corrected_seismic %>%
  filter(class==1) %>%
  ggplot(aes(shift)) +
  geom_bar(width = 0.1,fill="red",col="black") +
  xlab("type of a shift (W - coal-getting, N -preparation shift)") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  ggtitle("shift type distribution on hazardous state \n(class 1)")

corrected_seismic %>%
  filter(class==0) %>%
  ggplot(aes(shift)) +
  geom_bar(width = 0.1,fill="red",col="black") +
  xlab("type of a shift (W - coal-getting, N -preparation shift)") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  ggtitle("shift type distribution on non-hazardous state \n(class 0)")
```

### 2.2.4 Seismic energy recorded in previous shift (genergy) in mine with hazardous and non-hazardous state

This presents the records of seismic energy in the previous shift in mine with hazardous and non-hazardous state. By observing the below graph, the quartiles of seismic energy are having a higher value in mine with hazardous state than mine with non-hazardous state. It shows that the magnitude of previous seismic energy gives a significant effect on energy of seismic bumps in the next shift. That is, the higher the previous seismic energy is, the higher the chance of high energy seismic bump happens in the next shift. 

Another thing we observed from the findings is that the range is larger, and the quartile range is smaller in the negative class data set. The reason of this fluctuation may be due to the imbalance number of observations in positive class and negative class.

```{r}
corrected_seismic %>% 
  mutate(genergy_tran = genergy+1) %>%
  ggplot(aes(genergy_tran)) +
  geom_boxplot(fill="white") +
  scale_x_continuous(trans = "log10") +
  xlab("log(seismic energy in previous shift) / J") +
  theme_bw() +
  theme(plot.title = element_text(size = 10, face = "bold")) +
  facet_grid(class~.) +
  ggtitle("genergy in mine with hazardous state (class 1) and non-hazardous state (class 0)")

```

### 2.2.5 Deviation of Seismic energy recorded in previous shift (gdenergy) in mine with hazardous and non-hazardous state

The deviation of records of seismic energy in the previous shift in mine with hazardous and non-hazardous state is presented in below graph. It is observed that other than the upper range, the distribution of deviation of seismic energy in the previous shift is almost the same in both classes (i.e. mine with hazardous state and non-hazardous state). Therefore the information given by the deviation of seismic energy in the previous shift is not enough for the prediction of occurrence of high energy seismic bumps in the next shift.

The difference in range of data set may cause by the imbalance number of observations in positive class and negative class. 

```{r}
corrected_seismic %>% 
  mutate(gdenergy_absolute = ifelse(gdenergy<0,-gdenergy,gdenergy)) %>%
  mutate(gdenergy_tran = ifelse(gdenergy_absolute==0,gdenergy_absolute+1,gdenergy_absolute)) %>%
  ggplot(aes(gdenergy_tran)) +
  geom_boxplot(fill="white") +
  scale_x_continuous(trans = "log10") +
  xlab("log(deviation of seismic energy in previous shift) / J") +
  theme_bw() +
  theme(plot.title = element_text(size = 10, face = "bold")) +
  facet_grid(class~.) +
  ggtitle("gdenergy in mine with hazardous state (class 1) and non-hazardous state (class 0)")
```

### 2.2.6 Number of pulses recorded in previous shift (gpuls) in mine with hazardous and non-hazardous state

The below graph shows the distribution of number of seismic pulses recorded in previous shift on the two classes (i.e. mine with hazardous and non-hazardous state). It is observed that the more the seismic pulses recorded in the previous shift, the higher chance the high energy seismic bump occurs in the next shift.From this observation, 'gpuls' seems a good attribute for classifying whether the mine is in hazardous state or non-hazardous state.

```{r}
corrected_seismic %>% 
  mutate(class = as.character(class)) %>%
  ggplot(aes(gpuls,fill=class)) +
  geom_density(alpha=0.4) +
  scale_x_continuous(trans = "log10") +
  xlab("Number of pulses in previous shift") +
  theme_bw() +
  theme(plot.title = element_text(size = 10, face = "bold")) +
  ggtitle("gpuls on hazardous state (class 1) and non-hazardous state (class 0)")
```

### 2.2.7 Deviation of number of pulses recorded in previous shift (gdpuls) in mine with hazardous and non-hazardous state

Here we try to observe how deviation of number of seismic pulses recorded in the previous shift would affect the occurrence of high energy bumps in next shift. In the below graph, the distributions of deviation of number of pulses in the previous shift in both classes 

```{r}
corrected_seismic %>% 
  mutate(class = as.character(class)) %>%
  mutate(gdpuls_absolute = ifelse(gdpuls<0,-gdpuls,gdpuls)) %>%
  mutate(gdpuls_tran = ifelse(gdpuls_absolute==0,gdpuls_absolute+1,gdpuls_absolute)) %>%
  ggplot(.,aes(x=gdpuls_tran,fill=class)) +
  geom_density(alpha=0.4) +
  scale_x_continuous(trans = "log10") +
  xlab("Deviation of number of pulses in previous shift") +
  theme_bw() +
  theme(plot.title = element_text(size = 10, face = "bold")) +
  ggtitle("gdpuls on hazardous state (class 1) and non-hazardous state (class 0)")
```

### 2.2.8 Ratio between ghazard on positive class and negative class

```{r, echo=FALSE, fig.show="hold", out.width="50%"}
corrected_seismic %>%
  filter(class==1) %>%
  ggplot(aes(ghazard)) +
  geom_bar(width = 0.1,fill="red",col="black") +
  xlab("a - lack of hazard, b - low hazard") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  ggtitle("ghazard distribution on hazardous state (class 1)")
  

corrected_seismic %>%
  filter(class==0) %>%
  ggplot(aes(ghazard)) +
  geom_bar(width = 0.2,fill="red",col="black") +
  xlab("a - lack of hazard, b - low hazard, c - high hazard") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  ggtitle("ghazard distribution on non-hazardous state(class 0)")
```

### 2.2.9 Effects by number of bumps with diff. energy range

```{r, include=FALSE}
#In each class, calculate total numbers of bumps with diff. energy range 
corrected_seismic %>%
  select(class,nbumps,nbumps2,nbumps3,nbumps4,nbumps5) %>%
  group_by(class) %>%
  summarize(sum(nbumps),sum(nbumps2),sum(nbumps3),sum(nbumps4),sum(nbumps5))
#create two data frames for each class   
bumps_c0<- data.frame(bumps_sum = c(1856,848,847,150,11))
bumps_c1<- data.frame(bumps_sum = c(362,168,168,25,1))
```


```{r, echo=FALSE, fig.show="hold", out.width="50%"}
#plot the positive class and negative class result
ggplot(bumps_c1, aes(x=row.names(bumps_c1), y=bumps_sum)) +
  geom_col(fill="red",color="black", width = 0.3) +
  xlab("summed bumps with diff. energy range") +
  ylab("count") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  ggtitle("Proportion of bumps with diff. energy range \non hazardous state (class 1)")
ggplot(bumps_c0, aes(x=row.names(bumps_c0), y=bumps_sum)) +
  geom_col(fill="red",color="black", width = 0.3) +
  xlab("summed bumps with diff. energy range") +
  ylab("count") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  ggtitle("Proportion of bumps with diff. energy range \non non-hazardous state (class 0)")
```

### 2.2.10 energy on positive class and negative class

```{r}
corrected_seismic %>%
  ggplot(aes(energy)) +
  geom_boxplot() +
  scale_x_continuous(trans = "log10") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  facet_grid(class~.) +
  ggtitle("energy on hazardous state (class 1) and non-hazardous state (class 0))")
```


### 2.2.11 maxenergy on positive class and negative class

```{r}
corrected_seismic %>%
  ggplot(aes(maxenergy)) +
  geom_boxplot() +
  scale_x_continuous(trans = "log10") +
  theme_bw() +
  theme(plot.title = element_text(size = 15, face = "bold")) +
  facet_grid(class~.) +
  ggtitle("maxenergy on hazardous state (class 1) and non-hazardous state (class 0))")
```


### 2.2.12 explore correlation between numeric variables


```{r, include=FALSE}
NumericVariables<- corrected_seismic %>%
  select(genergy,gpuls,gdenergy,gdpuls,energy,maxenergy)
```

```{r, echo=FALSE}
corrplot.mixed(cor(NumericVariables), lower.col = "black", number.cex = .7)
```


## 2.3 Modeling Approach


***
# 3. Results and Discussion


***
# 4. Conclusion and Future Work

## 4.1 Limitation
More and more advanced seismic and seismoacoustic monitoring systems allow a better understanding rock mass processes and definition of seismic hazard prediction methods. 
Accuracy of so far created methods is however far from perfect. 
Complexity of seismic processes and big disproportion between the number of low-energy seismic events and the number 
of high-energy phenomena (e.g. > 10^4J) causes the statistical techniques to be insufficient to predict 
seismic hazard
Therefore, it is essential to search for new opportunities of better hazard prediction, 
also using machine learning methods.
Unbalanced distribution of positive ('hazardous state') and negative 
('non-hazardous state') examples is a serious problem in seismic hazard prediction. Currently used 
methods are still insufficient to achieve good sensitivity and specificity of predictions.
***
# Aknowledgement
Marek Sikora^{1,2} (marek.sikora '@' polsl.pl), Lukasz Wrobel^{1} (lukasz.wrobel '@' polsl.pl) 
(1) Institute of Computer Science, Silesian University of Technology, 44-100 Gliwice, Poland 
(2) Institute of Innovative Technologies EMAG, 40-189 Katowice, Poland
***
# Reference
* 1. Lesniak A., Isakow Z.: Space-time clustering of seismic events and hazard assessment in the 
Zabrze-Bielszowice coal mine, Poland. Int. Journal of Rock Mechanics and Mining Sciences, 46(5), 2009, 
918-928
* 2. Kabiesz, J.: Effect 
of the form of data on the quality of mine tremors hazard forecasting using neural networks. 
Geotechnical and Geological Engineering, 24(5), 2005, 1131-1147
* 3. 
